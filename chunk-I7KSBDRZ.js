import{g as x}from"./chunk-NPOKFU2J.js";import{Ra as C}from"./chunk-G4XN575R.js";import{ea as W,g as k,h as m,j as p,ja as y,m as f,n as w,p as S}from"./chunk-ZY3XLMOC.js";var g={url:"",deserializer:c=>JSON.parse(c.data),serializer:c=>JSON.stringify(c)},j="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",b=class c extends w{constructor(t,e){if(super(),this._socket=null,t instanceof p)this.destination=e,this.source=t;else{let s=this._config=Object.assign({},g);if(this._output=new f,typeof t=="string")s.url=t;else for(let r in t)t.hasOwnProperty(r)&&(s[r]=t[r]);if(!s.WebSocketCtor&&WebSocket)s.WebSocketCtor=WebSocket;else if(!s.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new S}}lift(t){let e=new c(this._config,this.destination);return e.operator=t,e.source=this,e}_resetState(){this._socket=null,this.source||(this.destination=new S),this._output=new f}multiplex(t,e,s){let r=this;return new p(n=>{try{r.next(t())}catch(a){n.error(a)}let o=r.subscribe({next:a=>{try{s(a)&&n.next(a)}catch(i){n.error(i)}},error:a=>n.error(a),complete:()=>n.complete()});return()=>{try{r.next(e())}catch(a){n.error(a)}o.unsubscribe()}})}_connectSocket(){let{WebSocketCtor:t,protocol:e,url:s,binaryType:r}=this._config,n=this._output,o=null;try{o=e?new t(s,e):new t(s),this._socket=o,r&&(this._socket.binaryType=r)}catch(i){n.error(i);return}let a=new k(()=>{this._socket=null,o&&o.readyState===1&&o.close()});o.onopen=i=>{let{_socket:u}=this;if(!u){o.close(),this._resetState();return}let{openObserver:_}=this._config;_&&_.next(i);let d=this.destination;this.destination=m.create(h=>{if(o.readyState===1)try{let{serializer:l}=this._config;o.send(l(h))}catch(l){this.destination.error(l)}},h=>{let{closingObserver:l}=this._config;l&&l.next(void 0),h&&h.code?o.close(h.code,h.reason):n.error(new TypeError(j)),this._resetState()},()=>{let{closingObserver:h}=this._config;h&&h.next(void 0),o.close(),this._resetState()}),d&&d instanceof S&&a.add(d.subscribe(this.destination))},o.onerror=i=>{this._resetState(),n.error(i)},o.onclose=i=>{o===this._socket&&this._resetState();let{closeObserver:u}=this._config;u&&u.next(i),i.wasClean?n.complete():n.error(i)},o.onmessage=i=>{try{let{deserializer:u}=this._config;n.next(u(i))}catch(u){n.error(u)}}}_subscribe(t){let{source:e}=this;return e?e.subscribe(t):(this._socket||this._connectSocket(),this._output.subscribe(t),t.add(()=>{let{_socket:s}=this;this._output.observers.length===0&&(s&&(s.readyState===1||s.readyState===0)&&s.close(),this._resetState())}),t)}unsubscribe(){let{_socket:t}=this;t&&(t.readyState===1||t.readyState===0)&&t.close(),this._resetState(),super.unsubscribe()}};var B=(()=>{class c{constructor(e){this.accounts=e,this.baseURL=C.baseURL.replace("http","ws"),this.connectedWS=!1,this.connectedCurtainWS=!1,this.lostConnectionSubject=new f}connectSearchWS(e){this.searchWSConnection=new b({url:`${this.baseURL}/ws/search/${e}/?token=${this.accounts.token}`,openObserver:{next:()=>{this.connectedWS=!0,console.log("Connected to search websocket")}},closeObserver:{next:()=>{console.log("Closed connection to search websocket"),this.lostConnectionSubject.next("search"),this.connectedWS=!1}}})}connectCurtainWS(e){this.curtainWSConnection=new b({url:`${this.baseURL}/ws/curtain/${e}/?token=${this.accounts.token}`,openObserver:{next:()=>{this.connectedCurtainWS=!0,console.log("Connected to curtain websocket")}},closeObserver:{next:()=>{console.log("Closed connection to curtain websocket"),this.lostConnectionSubject.next("curtain"),this.connectedCurtainWS=!1}}})}closeSearchWS(){this.searchWSConnection&&this.searchWSConnection.unsubscribe()}closeCurtainWS(){this.curtainWSConnection&&this.curtainWSConnection.unsubscribe()}static{this.\u0275fac=function(s){return new(s||c)(y(x))}}static{this.\u0275prov=W({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();export{B as a};
